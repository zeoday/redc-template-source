name: CI - Strict Validator

on:
  push:
    branches: [ "master" ]
    paths-ignore:
      - 'public/**'
      - 'index.html'
  pull_request:
    branches: [ "master" ]

jobs:
  validate:
    name: Validate Standards
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "latest"

      - name: Run Validation Script
        run: |
          python3 -c "
          import os
          import json
          import sys
          import subprocess

          # ==========================================
          #               é…ç½®åŒºåŸŸ
          # ==========================================
          
          # å®šä¹‰ case.json ä¸­å¿…é¡»å­˜åœ¨çš„æ ¸å¿ƒå­—æ®µ
          # key: å­—æ®µå (åŒºåˆ†å¤§å°å†™)
          # value: æŠ¥é”™æ—¶æ˜¾ç¤ºçš„æè¿°
          
          REQUIRED_FIELDS = {
              'name':        'æ¨¡ç‰ˆåç§° (name)',
              'user':        'ä½œè€… (user)',
              'version':     'ç‰ˆæœ¬å· (version)',
              'description': 'æè¿°ä¿¡æ¯ (description)'
          }

          # å¿½ç•¥çš„ç›®å½•å’Œæ–‡ä»¶
          repo_root = '.'
          exclude_dirs = {'.git', '.github', 'public', 'previous_build', '__pycache__'}
          
          # ==========================================
          #               ä¸»æ ¡éªŒé€»è¾‘
          # ==========================================

          has_error = False
          print('ğŸ” Starting Strict Validation...')
          print(f'â„¹ï¸  Enforcing required fields: {list(REQUIRED_FIELDS.keys())}')
          print(f'â„¹ï¸  Extra fields in case.json are allowed.')
          print('=' * 60)

          for provider in sorted(os.listdir(repo_root)):
              provider_path = os.path.join(repo_root, provider)
              if not os.path.isdir(provider_path) or provider in exclude_dirs:
                  continue

              for template in sorted(os.listdir(provider_path)):
                  template_path = os.path.join(provider_path, template)
                  if not os.path.isdir(template_path): continue

                  template_id = f'{provider}/{template}'
                  current_files = set(os.listdir(template_path))
                  
                  # -------------------------------------------------
                  # Check 1: README.md (ä¸¥æ ¼å¤§å†™æ£€æŸ¥)
                  # -------------------------------------------------
                  if 'README.md' not in current_files:
                      # æ£€æŸ¥æ˜¯å¦è¯¯å†™æˆäº†å°å†™
                      lower_files = [f.lower() for f in current_files]
                      if 'readme.md' in lower_files:
                          print(f'âŒ [FILE] {template_id}: Found lowercase readme.md. MUST be CAPS: README.md')
                      else:
                          print(f'âŒ [FILE] {template_id}: Missing required file: README.md')
                      has_error = True

                  # -------------------------------------------------
                  # Check 2: case.json (æ ¸å¿ƒå­—æ®µä¸ç±»å‹æ£€æŸ¥)
                  # -------------------------------------------------
                  case_path = os.path.join(template_path, 'case.json')
                  if 'case.json' not in current_files:
                      print(f'âŒ [FILE] {template_id}: Missing required file: case.json')
                      has_error = True
                  else:
                      try:
                          with open(case_path, 'r', encoding='utf-8') as f:
                              data = json.load(f)
                              
                              # [2.1] æ£€æŸ¥æ ¸å¿ƒå­—æ®µæ˜¯å¦ç¼ºå¤±
                              # åªè¦ REQUIRED_FIELDS é‡Œçš„éƒ½æœ‰å°±è¡Œï¼Œå¤šä½™çš„å­—æ®µä¸å½±å“
                              missing = [k for k in REQUIRED_FIELDS if k not in data]
                              
                              if missing:
                                  # æ™ºèƒ½æç¤ºï¼šå¦‚æœå‘ç°äº†æ—§çš„å¤§å†™ DESCRIPTION
                                  if 'description' in missing and 'DESCRIPTION' in data:
                                      print(f'âŒ [JSON] {template_id}: Found legacy key \"DESCRIPTION\". Please rename to lowercase \"description\"')
                                  else:
                                      desc_list = [REQUIRED_FIELDS[k] for k in missing]
                                      print(f'âŒ [JSON] {template_id}: Missing required fields: {desc_list}')
                                  has_error = True
                              else:
                                  # [2.2] å­—æ®µå†…å®¹åˆè§„æ€§æ£€æŸ¥
                                  
                                  # Check: Name (éç©º)
                                  if not data['name'] or str(data['name']).strip() == '':
                                      print(f'âŒ [JSON] {template_id}: Field "name" cannot be empty')
                                      has_error = True

                                  # Check: User (éç©º)
                                  if not data['user'] or str(data['user']).strip() == '':
                                      print(f'âŒ [JSON] {template_id}: Field "user" cannot be empty')
                                      has_error = True

                                  # Check: Description (éç©º)
                                  if not data['description'] or str(data['description']).strip() == '':
                                      print(f'âŒ [JSON] {template_id}: Field "description" cannot be empty')
                                      has_error = True

                                  # Check: Version (å¿…é¡»æ˜¯å­—ç¬¦ä¸²ä¸”éç©º)
                                  ver = data['version']
                                  if not isinstance(ver, str):
                                      print(f'âŒ [JSON] {template_id}: "version" must be a STRING (e.g. \"1.0.1\"), found type: {type(ver).__name__}')
                                      has_error = True
                                  elif ver.strip() == '':
                                      print(f'âŒ [JSON] {template_id}: Field "version" cannot be empty')
                                      has_error = True

                      except json.JSONDecodeError as e:
                          print(f'âŒ [JSON] {template_id}: case.json is invalid JSON! Error: {e}')
                          has_error = True

                  # -------------------------------------------------
                  # Check 3: Terraform æ ¼å¼ (fmt -check)
                  # -------------------------------------------------
                  has_tf = any(f.endswith('.tf') for f in current_files)
                  if has_tf:
                      result = subprocess.run(
                          ['terraform', 'fmt', '-check', template_path],
                          stdout=subprocess.PIPE,
                          stderr=subprocess.PIPE,
                          text=True
                      )
                      if result.returncode != 0:
                          print(f'âŒ [TF] {template_id}: Terraform files not formatted. Run "terraform fmt" locally.')
                          has_error = True

          print('=' * 60)
          if has_error:
              print('ğŸš« CHECK FAILED. Please fix the errors above.')
              sys.exit(1)
          else:
              print('âœ… ALL CHECKS PASSED. Ready to merge.')
              sys.exit(0)
          "
