name: Build and Deploy

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild current version'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  wait-for-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for validation to complete
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'Validate Standards'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  build-and-deploy:
    needs: wait-for-validation
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–æºç  (æœ€æ–°ç‰ˆ)
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. ä¸‹è½½æ—§çš„ index.json (ç”¨äºåˆå¹¶æ•°æ®ï¼Œæ— éœ€ä¸‹è½½ ZIP)
      - name: Fetch Current Index
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # æ„é€  URL
          INDEX_URL="https://redc.${REPO_OWNER}.org/index.json"
          echo "â¬‡ï¸ Fetching index from: $INDEX_URL"
          
          # å°è¯•ä¸‹è½½ï¼Œå¦‚æœå¤±è´¥ï¼ˆæ¯”å¦‚ç¬¬ä¸€æ¬¡è¿è¡Œï¼‰åˆ™åˆ›å»ºä¸€ä¸ªç©ºçš„ JSON
          curl -sL "$INDEX_URL" -o prev_index.json || echo '{"templates": {}}' > prev_index.json
          
          # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™é‡ç½®
          if ! jq . prev_index.json >/dev/null 2>&1; then
            echo '{"templates": {}}' > prev_index.json
          fi

      # 3. æ„å»ºè„šæœ¬ (åªæ‰“åŒ…å˜åŠ¨çš„/æ–°çš„)
      - name: Build with Python
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          FORCE_REBUILD: ${{ inputs.force_rebuild }}
        run: |
          mkdir -p public/templates
          [ -f index.html ] && cp index.html public/index.html

          python3 -c "
          import os
          import json
          import shutil
          import hashlib
          import datetime

          # --- é…ç½® ---
          repo_owner = os.environ.get('REPO_OWNER')
          repo_name = os.environ.get('REPO_NAME')
          force_rebuild = os.environ.get('FORCE_REBUILD') == 'true'
          
          base_url = f'https://redc.${REPO_OWNER}.org'
          output_dir = 'public'
          templates_dir = os.path.join(output_dir, 'templates')
          
          # æ—§ç´¢å¼•è·¯å¾„
          prev_index_path = 'prev_index.json'

          if not os.path.exists(templates_dir): os.makedirs(templates_dir)

          # --- A. åŠ è½½æ—§ç´¢å¼• ---
          manifest_data = {}
          try:
              with open(prev_index_path, 'r', encoding='utf-8') as f:
                  old_json = json.load(f)
                  if isinstance(old_json.get('templates'), dict):
                      manifest_data = old_json['templates']
          except:
              print('âš ï¸ Failed to load prev_index.json, starting fresh.')

          # --- B. éå†å¤„ç† ---
          repo_root = '.'
          exclude = {'.git', '.github', 'public', 'previous_build', '.gitignore', 'index.html'}
          
          # æ ‡è®°æœ¬æ¬¡æ„å»ºæ˜¯å¦æœ‰æ›´æ–° (å¦‚æœæ²¡æœ‰æ›´æ–°ï¼Œç”šè‡³å¯ä»¥ä¸æäº¤ index.jsonï¼Œä½†ä¸ºäº†æ›´æ–°æ—¶é—´æˆ³è¿˜æ˜¯æäº¤å§)
          has_changes = False
          
          # è·Ÿè¸ªå½“å‰æ‰«æåˆ°çš„æ‰€æœ‰æ¨¡æ¿ ID
          current_template_ids = set()

          for provider in sorted(os.listdir(repo_root)):
              provider_path = os.path.join(repo_root, provider)
              if not os.path.isdir(provider_path) or provider in exclude: continue

              for template in sorted(os.listdir(provider_path)):
                  template_path = os.path.join(provider_path, template)
                  if not os.path.isdir(template_path): continue

                  template_id = f'{provider}/{template}'
                  current_template_ids.add(template_id)
                  
                  # 1. è¯»å–æœ¬åœ°æœ€æ–°ä¿¡æ¯
                  meta_name = template; meta_user = 'Unknown'; meta_desc = 'No description.'; meta_version = '0.0.0'
                  case_path = os.path.join(template_path, 'case.json')
                  try:
                      if os.path.exists(case_path):
                          with open(case_path, 'r', encoding='utf-8') as cf:
                              c = json.load(cf)
                              meta_name = c.get('name', template)
                              meta_user = c.get('user', 'Unknown')
                              meta_desc = c.get('description', 'No description.')
                              meta_version = c.get('version', '0.0.0')
                  except: pass

                  # è¯»å– README
                  readme_content = ''
                  readme_path = os.path.join(template_path, 'README.md')
                  try:
                      if os.path.exists(readme_path):
                          with open(readme_path, 'r', encoding='utf-8') as rf: readme_content = rf.read()
                  except: pass

                  # 2. åˆå§‹åŒ–å…ƒæ•°æ®ç»“æ„
                  if template_id not in manifest_data:
                      manifest_data[template_id] = {
                          'id': template_id, 'provider': provider, 'slug': template, 'versions': {}
                      }
                  
                  # æ€»æ˜¯æ›´æ–°é€šç”¨å…ƒæ•°æ® (Title/Desc/Readme)
                  manifest_data[template_id]['latest'] = meta_version
                  manifest_data[template_id]['metadata'] = {
                      'name': meta_name, 'author': meta_user, 'description': meta_desc, 'readme': readme_content
                  }

                  # 3. æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨
                  zip_filename = f'{provider}_{template}_v{meta_version}.zip'
                  zip_output_path = os.path.join(templates_dir, zip_filename)
                  
                  version_exists = meta_version in manifest_data[template_id]['versions']
                  
                  # åªæœ‰å½“ï¼šå¼ºåˆ¶é‡å»º OR ç‰ˆæœ¬ä¸å­˜åœ¨ æ—¶ï¼Œæ‰æ‰“åŒ…
                  if force_rebuild or not version_exists:
                      print(f'ğŸ”¨ Packaging: {zip_filename}')
                      shutil.make_archive(zip_output_path.replace('.zip', ''), 'zip', root_dir=template_path)
                      
                      h = hashlib.sha256()
                      with open(zip_output_path, 'rb') as f:
                          for chunk in iter(lambda: f.read(4096), b''): h.update(chunk)
                      
                      manifest_data[template_id]['versions'][meta_version] = {
                          'url': f'{base_url}/templates/{zip_filename}',
                          'sha256': h.hexdigest(),
                          'updated_at': datetime.datetime.utcnow().isoformat() + 'Z'
                      }
                      has_changes = True
                  else:
                      print(f'â© Skipping: {zip_filename} (Version exists in index)')

          # --- åˆ é™¤ä¸å†å­˜åœ¨çš„æ¨¡æ¿ ---
          deleted_templates = [tid for tid in manifest_data.keys() if tid not in current_template_ids]
          for template_id in deleted_templates:
              print(f'ğŸ—‘ï¸  Removing deleted template: {template_id}')
              del manifest_data[template_id]
              has_changes = True

          # --- C. ä¿å­˜ Index ---
          # å³ä½¿æ²¡æœ‰æ–° ZIPï¼Œæ›´æ–°ä¸€ä¸‹ updated_at ä¹Ÿæ˜¯å¥½çš„
          final_manifest = {
              'updated_at': datetime.datetime.utcnow().isoformat() + 'Z',
              'repo_name': repo_name,
              'templates': manifest_data
          }
          
          with open(os.path.join(output_dir, 'index.json'), 'w', encoding='utf-8') as f:
              json.dump(final_manifest, f, indent=2, ensure_ascii=False)
          
          print(f'âœ¨ Index updated.')
          "

      # 4. éƒ¨ç½² (Keep Files æ¨¡å¼)
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          keep_files: true
          commit_message: "Deploy: ${{ github.event.head_commit.message }}"
