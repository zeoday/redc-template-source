name: Build and Deploy (Bash)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout Previous Build
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: previous_build
          fetch-depth: 1
        continue-on-error: true

      - name: Build with Bash & jq
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          FORCE_REBUILD: ${{ inputs.force_rebuild }}
        run: |
          # --- 1. åˆå§‹åŒ–å˜é‡ä¸ŽçŽ¯å¢ƒ ---
          mkdir -p public/templates
          # å¤åˆ¶å‰ç«¯é¡µé¢
          [ -f index.html ] && cp index.html public/index.html

          BASE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}"
          OUTPUT_JSON="public/index.json"
          PREV_JSON="previous_build/index.json"
          
          # åˆå§‹åŒ–æ–°çš„ JSON ç»“æž„
          # ä½¿ç”¨ jq -n åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡
          jq -n \
            --arg date "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --arg repo "$REPO_NAME" \
            '{updated_at: $date, repo_name: $repo, templates: []}' > "$OUTPUT_JSON"

          # --- 2. éåŽ†åŒå±‚ç›®å½• ---
          # æŽ’é™¤éšè—ç›®å½•å’Œ public
          for provider in */ ; do
            provider=${provider%/} # åŽ»æŽ‰æœ«å°¾æ–œæ 
            if [[ "$provider" == "public" || "$provider" == "previous_build" || "$provider" == .* ]]; then continue; fi

            for template in "$provider"/*/ ; do
              template=${template%/}
              template_name=$(basename "$template")
              
              if [[ ! -d "$template" ]]; then continue; fi
              
              # æž„é€  ID å’Œ è·¯å¾„
              id="${provider}/${template_name}"
              zip_name="${provider}_${template_name}.zip"
              zip_path="public/templates/$zip_name"
              prev_zip_path="previous_build/templates/$zip_name"
              
              echo "ðŸ” Checking: $id"

              # --- 3. è®¡ç®—æºç ç›®å½•æŒ‡çº¹ (Source Hash) ---
              # find: åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ -> sha256sum: è®¡ç®—æ¯ä¸ªæ–‡ä»¶hash -> sha256sum: è®¡ç®—æ€»hash
              # è¿™ç§æ–¹å¼æžå¿«ä¸”ç¨³å®š
              current_src_hash=$(find "$template" -type f -not -path '*/.*' -print0 | sort -z | xargs -0 sha256sum | sha256sum | awk '{print $1}')

              # --- 4. å¢žé‡åˆ¤æ–­é€»è¾‘ ---
              should_rebuild="true"
              old_entry="null"
              
              # å°è¯•ä»Žæ—§ JSON ä¸­è¯»å–è¯¥æ¨¡ç‰ˆçš„ä¿¡æ¯
              if [[ -f "$PREV_JSON" ]]; then
                old_entry=$(jq --arg id "$id" '.templates[] | select(.id == $id)' "$PREV_JSON")
              fi
              
              # èŽ·å–æ—§çš„ source_hash (å¦‚æžœå­˜åœ¨)
              old_src_hash=$(echo "$old_entry" | jq -r '.source_hash // empty')
              
              # åˆ¤æ–­æ¡ä»¶
              if [[ "$FORCE_REBUILD" != "true" && -n "$old_src_hash" && "$old_src_hash" == "$current_src_hash" && -f "$prev_zip_path" ]]; then
                should_rebuild="false"
              fi

              # --- 5. æ‰§è¡Œæž„å»ºæˆ–å¤ç”¨ ---
              final_zip_hash=""
              
              if [[ "$should_rebuild" == "true" ]]; then
                echo "   ðŸ”¨ Building..."
                # è¿™é‡Œçš„ cd æ˜¯ä¸ºäº†è®© zip å†…éƒ¨ç»“æž„æ›´å¹²å‡€ï¼Œä¸åŒ…å« provider/template çˆ¶ç›®å½•
                # å¦‚æžœä½ æƒ³ zip åŒ…å« provider/template ç»“æž„ï¼Œå¯ä»¥ç›´æŽ¥ zip -r ...
                # è¿™é‡Œæˆ‘ä»¬åªæ‰“åŒ…æ¨¡ç‰ˆå†…å®¹ï¼š
                (cd "$template" && zip -r -q "../../../$zip_path" .)
                
                final_zip_hash=$(sha256sum "$zip_path" | awk '{print $1}')
              else
                echo "   â© Skipping (Cached)"
                cp "$prev_zip_path" "$zip_path"
                final_zip_hash=$(echo "$old_entry" | jq -r '.sha256')
              fi

              # --- 6. è¯»å– Metadata (case.json) ---
              # é»˜è®¤å€¼
              meta_name="$template_name"
              meta_author="Unknown"
              meta_desc="No description provided."
              
              case_file="$template/case.json"
              if [[ -f "$case_file" ]]; then
                # éªŒè¯ json æœ‰æ•ˆæ€§ï¼Œå¦‚æžœæ— æ•ˆåˆ™å›žé€€é»˜è®¤
                if jq -e . "$case_file" >/dev/null 2>&1; then
                  meta_name=$(jq -r '.name // "'"$template_name"'"' "$case_file")
                  meta_author=$(jq -r '.user // "Unknown"' "$case_file")
                  meta_desc=$(jq -r '.DESCRIPTION // "No description provided."' "$case_file")
                fi
              fi

              # --- 7. æ›´æ–° index.json ---
              # ä½¿ç”¨ jq å°†æ–°æ¡ç›®è¿½åŠ åˆ° templates æ•°ç»„ä¸­
              # mktemp ç”¨äºŽåˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œå› ä¸ºä¸èƒ½åŒæ—¶è¯»å†™åŒä¸€ä¸ªæ–‡ä»¶
              tmp=$(mktemp)
              jq --arg id "$id" \
                 --arg provider "$provider" \
                 --arg slug "$template_name" \
                 --arg url "$BASE_URL/templates/$zip_name" \
                 --arg sha256 "$final_zip_hash" \
                 --arg src_hash "$current_src_hash" \
                 --arg name "$meta_name" \
                 --arg author "$meta_author" \
                 --arg desc "$meta_desc" \
                 '.templates += [{
                    id: $id,
                    provider: $provider,
                    slug: $slug,
                    url: $url,
                    sha256: $sha256,
                    source_hash: $src_hash,
                    metadata: {
                      name: $name,
                      author: $author,
                      description: $desc
                    }
                 }]' "$OUTPUT_JSON" > "$tmp" && mv "$tmp" "$OUTPUT_JSON"
                 
            done
          done
          
          echo "ðŸŽ‰ Build Complete. Index generated at $OUTPUT_JSON"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'public'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
