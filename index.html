<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redc Template Registry</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-dark.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0B0C15',
                            card: '#151725',
                            border: '#2A2D3D'
                        },
                        primary: {
                            500: '#6366f1', // Indigo
                            600: '#4f46e5'
                        }
                    },
                    maxWidth: {
                        '8xl': '90rem'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'blob': 'blob 7s infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* 全局样式 */
        body { background-color: #0B0C15; color: #e2e8f0; overflow-x: hidden; }
        
        /* 磨砂玻璃效果 */
        .glass-panel {
            background: rgba(21, 23, 37, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-card {
            background: linear-gradient(145deg, rgba(30, 32, 45, 0.6) 0%, rgba(21, 23, 37, 0.4) 100%);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.2);
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* 动态背景光晕 */
        .blob-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        .blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.4;
            border-radius: 50%;
            animation: blob 10s infinite alternate;
        }
    </style>
</head>
<body class="min-h-screen font-sans selection:bg-primary-500 selection:text-white">

    <div class="fixed top-6 right-6 z-40 flex gap-3">
        <button id="lang-switcher" onclick="toggleLanguage()"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-[#151725]/90 border border-slate-700 text-slate-200 hover:text-white hover:border-primary-500/60 hover:bg-slate-800/90 shadow-lg shadow-primary-500/10 transition">
            <i data-lucide="languages" class="w-4 h-4"></i>
            <span class="text-sm font-semibold" id="lang-text">EN</span>
        </button>
        <a href="https://github.com/wgpsec/redc-template" target="_blank" rel="noopener noreferrer"
           class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-[#151725]/90 border border-slate-700 text-slate-200 hover:text-white hover:border-primary-500/60 hover:bg-slate-800/90 shadow-lg shadow-primary-500/10 transition">
            <i data-lucide="github" class="w-4 h-4"></i>
            <span class="text-sm font-semibold" data-i18n="github_repo">GitHub 仓库</span>
        </a>
    </div>

    <div class="blob-bg">
        <div class="blob bg-purple-900 w-96 h-96 top-0 -left-20"></div>
        <div class="blob bg-blue-900 w-96 h-96 bottom-0 -right-20 animation-delay-2000"></div>
        <div class="blob bg-indigo-900 w-80 h-80 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 animation-delay-4000"></div>
    </div>

    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-10 py-12">
        <header class="text-center mb-16 animate-slide-up">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary-500/10 border border-primary-500/20 text-primary-500 text-xs font-medium mb-6">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary-500 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-primary-500"></span>
                </span>
                <span data-i18n="live_badge">Redc Registry Live</span>
            </div>
            
            <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight text-white mb-6">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500">
                    Redc
                </span> <span data-i18n="template_store">Template Store</span>
            </h1>
            
            <p class="text-slate-400 text-lg max-w-2xl mx-auto mb-10 leading-relaxed" data-i18n="hero_description">
                基于 Terraform 的红队基础设施即代码 (IaC) 仓库。
                <br>一键拉取，快速构建攻防环境。
            </p>

            <div class="group relative inline-flex items-center gap-3 px-6 py-4 bg-[#0B0C15]/80 border border-slate-700 rounded-2xl shadow-2xl hover:border-primary-500/50 transition-colors cursor-pointer"
                 onclick="copyCommand('redc pull <provider>/<template>')">
                <div class="flex gap-1.5">
                    <div class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
                </div>
                <div class="h-4 w-[1px] bg-slate-700 mx-2"></div>
                <code class="font-mono text-sm text-slate-300">
                    <span class="text-primary-500">redc</span> pull <span class="text-slate-500">&lt;provider&gt;/&lt;template&gt;</span>
                </code>
                <i data-lucide="copy" class="w-4 h-4 text-slate-500 group-hover:text-white transition ml-2"></i>
                
                <div class="absolute -top-10 left-1/2 -translate-x-1/2 px-3 py-1 bg-primary-600 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity">
                    <span data-i18n="click_to_copy">点击复制示例</span>
                </div>
            </div>
        </header>

        <div class="sticky top-6 z-30 mb-12 animate-slide-up" style="animation-delay: 0.1s;">
            <div class="relative max-w-2xl mx-auto">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="h-5 w-5 text-slate-400"></i>
                </div>
                <input type="text" id="search-input" 
                    class="block w-full pl-11 pr-4 py-4 bg-[#151725]/90 backdrop-blur-md border border-slate-700 rounded-xl text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-all shadow-xl"
                    data-i18n-placeholder="search_placeholder"
                    placeholder="搜索模版、云厂商、作者 (例如: aws c2 r0fus0d)...">
                <div class="absolute inset-y-0 right-0 pr-4 flex items-center">
                    <span id="result-count" class="text-xs text-slate-500 bg-slate-800 px-2 py-1 rounded-md hidden">0 items</span>
                </div>
            </div>
        </div>

        <div id="grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 animate-slide-up" style="animation-delay: 0.2s;">
            <div class="col-span-full flex flex-col items-center justify-center py-24 text-slate-500">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full border-4 border-slate-700 border-t-primary-500 animate-spin"></div>
                </div>
                <p class="mt-4 font-medium animate-pulse" data-i18n="loading">正在加载武器库...</p>
            </div>
        </div>

        <div id="empty-state" class="hidden text-center py-20 animate-fade-in">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-slate-800/50 mb-6">
                <i data-lucide="package-search" class="w-10 h-10 text-slate-500"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2" data-i18n="no_results">未找到相关模版</h3>
            <p class="text-slate-400" data-i18n="no_results_hint">尝试更换关键词，或者查看全部列表。</p>
            <button onclick="clearSearch()" class="mt-6 px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition border border-slate-700">
                <span data-i18n="clear_search">清除搜索</span>
            </button>
        </div>

        <footer class="mt-20 pt-8 border-t border-slate-800/50 text-center">
            <p class="text-slate-500 text-sm mb-2" id="build-info">Loading metadata...</p>
            <div class="flex justify-center gap-4 text-slate-600">
                <a href="https://github.com/wgpsec/redc-template" target="_blank" rel="noopener noreferrer" class="hover:text-primary-500 transition"><i data-lucide="github" class="w-5 h-5"></i></a>
            </div>
        </footer>
    </div>

    <div id="modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-[#0B0C15] border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-4xl opacity-0 scale-95" id="modal-panel">
                    
                    <div class="bg-[#151725] px-6 py-4 border-b border-slate-800 flex justify-between items-center sticky top-0 z-20">
                        <div>
                            <h3 class="text-lg font-bold text-white flex items-center gap-2" id="modal-title">
                                </h3>
                            <div class="flex gap-2 mt-1.5" id="modal-tags">
                                </div>
                        </div>
                        <button type="button" class="p-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition" onclick="closeModal()">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="px-8 py-8 bg-[#0B0C15] min-h-[300px] max-h-[70vh] overflow-y-auto custom-scrollbar">
                        <div id="markdown-content" class="markdown-body" style="background: transparent;">
                            </div>
                    </div>

                    <div class="bg-[#151725] px-6 py-4 border-t border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="text-xs text-slate-500 font-mono" id="modal-footer-info">
                            </div>
                        <div class="flex gap-3 w-full sm:w-auto">
                            <button onclick="closeModal()" class="flex-1 sm:flex-none px-4 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-800 rounded-lg transition">
                                <span data-i18n="close">关闭</span>
                            </button>
                            <button id="modal-copy-btn" class="flex-1 sm:flex-none inline-flex justify-center items-center gap-2 px-5 py-2 text-sm font-semibold text-white bg-primary-600 hover:bg-primary-500 rounded-lg shadow-lg shadow-primary-500/20 transition">
                                <i data-lucide="terminal" class="w-4 h-4"></i>
                                <span data-i18n="copy_command">复制命令</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-1/2 translate-x-1/2 sm:right-8 sm:translate-x-0 z-50 pointer-events-none">
        <div class="bg-emerald-500/10 backdrop-blur-md border border-emerald-500/20 text-emerald-400 px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 transform translate-y-20 transition-all duration-300 opacity-0" id="toast-body">
            <div class="bg-emerald-500/20 p-1 rounded-full">
                <i data-lucide="check" class="w-4 h-4"></i>
            </div>
            <span class="font-medium text-sm" data-i18n="copied">命令已复制到剪贴板</span>
        </div>
    </div>

    <script>
        // --- 国际化 (i18n) ---
        const translations = {
            'zh-CN': {
                github_repo: 'GitHub 仓库',
                live_badge: 'Redc Registry Live',
                template_store: 'Template Store',
                hero_description: '基于 Terraform 的红队基础设施即代码 (IaC) 仓库。<br>一键拉取，快速构建攻防环境。',
                search_placeholder: '搜索模版、云厂商、作者 (例如: aws c2 r0fus0d)...',
                loading: '正在加载武器库...',
                no_results: '未找到相关模版',
                no_results_hint: '尝试更换关键词，或者查看全部列表。',
                clear_search: '清除搜索',
                click_to_copy: '点击复制示例',
                close: '关闭',
                copy_command: '复制命令',
                copied: '命令已复制到剪贴板',
                docs: '文档',
                download_zip: '下载 ZIP',
                no_readme: '> *该模版暂无详细文档 (README.md)*'
            },
            'en': {
                github_repo: 'GitHub Repo',
                live_badge: 'Redc Registry Live',
                template_store: 'Template Store',
                hero_description: 'Red Team Infrastructure as Code (IaC) repository based on Terraform.<br>One-click pull to quickly build offensive and defensive environments.',
                search_placeholder: 'Search templates, providers, authors (e.g., aws c2 r0fus0d)...',
                loading: 'Loading arsenal...',
                no_results: 'No templates found',
                no_results_hint: 'Try different keywords or view the full list.',
                clear_search: 'Clear Search',
                click_to_copy: 'Click to copy example',
                close: 'Close',
                copy_command: 'Copy Command',
                copied: 'Command copied to clipboard',
                docs: 'Docs',
                download_zip: 'Download ZIP',
                no_readme: '> *This template has no detailed documentation (README.md)*'
            }
        };

        let currentLang = localStorage.getItem('redc-lang') || 'zh-CN';

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('redc-lang', lang);
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.innerHTML = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update language switcher button
            document.getElementById('lang-text').textContent = lang === 'zh-CN' ? 'EN' : '中文';
            
            // Update HTML lang attribute
            document.documentElement.lang = lang;

            // Re-render grid to update dynamic content
            if (filteredTemplates.length > 0) {
                renderGrid(filteredTemplates);
            }
        }

        function toggleLanguage() {
            const newLang = currentLang === 'zh-CN' ? 'en' : 'zh-CN';
            setLanguage(newLang);
        }

        // --- 核心逻辑 ---
        let allTemplates = [];
        let filteredTemplates = [];

        // 1. 初始化
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLang); // Set initial language
            fetchData();
            setupSearch();
            lucide.createIcons();
        });

        // 2. 数据获取 (带缓存清理)
        async function fetchData() {
            try {
                // 加时间戳防止缓存
                const response = await fetch(`./index.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Failed to load data');
                const data = await response.json();
                
                // 数据归一化处理
                if (Array.isArray(data.templates)) {
                    allTemplates = data.templates;
                } else if (typeof data.templates === 'object') {
                    // 处理 dict 格式: { "id": { data } }
                    allTemplates = Object.values(data.templates);
                } else {
                    allTemplates = [];
                }

                // 排序：按更新时间倒序
                allTemplates.sort((a, b) => {
                    const dateA = new Date(a.versions?.[a.latest]?.updated_at || a.updated_at || 0);
                    const dateB = new Date(b.versions?.[b.latest]?.updated_at || b.updated_at || 0);
                    return dateB - dateA;
                });

                // 更新页脚
                const buildDate = new Date(data.updated_at);
                document.getElementById('build-info').innerHTML = 
                    `Last Updated: <span class="text-slate-400">${buildDate.toLocaleString()}</span> • Repo: <span class="text-slate-400">${data.repo_name || 'Redc'}</span> • Total: <span class="text-slate-400">${allTemplates.length}</span>`;

                // 初始渲染
                filteredTemplates = allTemplates;
                renderGrid(allTemplates);

            } catch (error) {
                console.error(error);
                document.getElementById('grid-container').innerHTML = `
                    <div class="col-span-full text-center py-20 bg-red-500/10 border border-red-500/20 rounded-2xl">
                        <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500 mx-auto mb-4"></i>
                        <h3 class="text-lg font-bold text-red-400">加载失败</h3>
                        <p class="text-red-400/60 text-sm mt-2">${error.message}</p>
                    </div>`;
                lucide.createIcons();
            }
        }

        // 3. 搜索功能 (核心优化：防抖 + DOM diff)
        function setupSearch() {
            const input = document.getElementById('search-input');
            
            // 防抖函数：防止每输入一个字就渲染一次
            const debounce = (fn, delay) => {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn(...args), delay);
                }
            };

            const handleSearch = debounce((e) => {
                const term = e.target.value.toLowerCase().trim();
                
                if (!term) {
                    filteredTemplates = allTemplates;
                } else {
                    filteredTemplates = allTemplates.filter(t => {
                        const meta = t.metadata || {};
                        return (t.id || '').toLowerCase().includes(term) ||
                               (meta.name || '').toLowerCase().includes(term) ||
                               (meta.description || '').toLowerCase().includes(term) ||
                               (meta.author || '').toLowerCase().includes(term) ||
                               (t.provider || '').toLowerCase().includes(term);
                    });
                }
                renderGrid(filteredTemplates);
            }, 300); // 300ms 延迟

            input.addEventListener('input', handleSearch);
        }

        function clearSearch() {
            const input = document.getElementById('search-input');
            input.value = '';
            input.dispatchEvent(new Event('input'));
        }

        // 4. 渲染逻辑 (美化版)
        function renderGrid(templates) {
            const container = document.getElementById('grid-container');
            const emptyState = document.getElementById('empty-state');
            const resultCount = document.getElementById('result-count');
            
            // Get current translations
            const t = translations[currentLang];
            
            // 更新计数
            resultCount.textContent = `${templates.length} items`;
            resultCount.classList.remove('hidden');

            if (templates.length === 0) {
                container.innerHTML = '';
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.classList.remove('hidden');

            // 构造 HTML 字符串 (比 createElement 性能更好)
            const html = templates.map(t => {
                const meta = t.metadata || {};
                const name = meta.name || t.slug;
                const desc = meta.description || '暂无描述';
                const author = meta.author || 'Unknown';
                const version = t.latest || t.version || '0.0.1';
                const provider = t.provider || t.id.split('/')[0];
                
                // 根据 Provider 生成固定颜色
                const providerKey = provider.toLowerCase();
                const providerColorMap = {
                    aliyun: '#ff6a00',
                    alibaba: '#ff6a00',
                    tencent: '#0052d9',
                    aws: '#ff9900',
                    vultr: '#007bfc'
                };
                const tagColor = providerColorMap[providerKey] || '#64748b';
                const tagStyle = `color: ${tagColor}; border-color: ${tagColor}33; background-color: ${tagColor}1a;`;

                return `
                <div class="glass-card rounded-xl p-6 flex flex-col h-full group relative overflow-hidden animate-fade-in min-h-[280px]">
                    <div class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-primary-500/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex gap-2">
                            <span class="px-2.5 py-1 text-[11px] font-bold uppercase tracking-wider rounded border" style="${tagStyle}">
                                ${provider}
                            </span>
                        </div>
                        <span class="text-[11px] font-mono text-slate-500 bg-slate-800/50 px-2 py-1 rounded border border-slate-700/50">v${version}</span>
                    </div>

                    <h3 class="text-xl font-bold text-slate-200 group-hover:text-primary-400 transition cursor-pointer mb-3 line-clamp-1"
                        onclick="openModal('${t.id}')" title="${name}">
                        ${name}
                    </h3>
                    
                    <p class="text-slate-400 text-sm leading-relaxed mb-5 line-clamp-3 min-h-[60px]">
                        ${desc}
                    </p>

                    <div class="mt-auto pt-4 border-t border-slate-700/50 flex flex-col gap-3">
                        <div class="flex justify-between items-center text-xs text-slate-500">
                             <div class="flex items-center gap-1.5" title="Author">
                                <i data-lucide="user" class="w-3 h-3"></i>
                                <span class="truncate max-w-[100px]">${author}</span>
                            </div>
                            <button onclick="openModal('${t.id}')" class="flex items-center gap-1 text-slate-400 hover:text-white transition group/btn">
                                <i data-lucide="book-open" class="w-3 h-3"></i>
                                <span class="group-hover/btn:underline">${t.docs || '文档'}</span>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2">
                             <button onclick="copyCommand('redc pull ${t.id}')" 
                                class="col-span-3 flex items-center justify-center gap-2 py-2 bg-slate-800 hover:bg-primary-600 hover:text-white text-slate-300 text-xs font-medium rounded-lg border border-slate-700 hover:border-primary-500 transition-all active:scale-95">
                                <i data-lucide="terminal" class="w-3 h-3"></i>
                                Pull
                            </button>
                            <a href="${t.versions?.[version]?.url || '#'}" class="col-span-1 flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white rounded-lg border border-slate-700 transition" title="${translations[currentLang].download_zip || '下载 ZIP'}">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </a>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            container.innerHTML = html;
            lucide.createIcons();
        }

        // 5. 弹窗逻辑 (美化版)
        function openModal(templateId) {
            const t = allTemplates.find(item => item.id === templateId);
            if (!t) return;

            const meta = t.metadata || {};
            const version = t.latest || t.version;

            // 填充内容
            document.getElementById('modal-title').innerHTML = `
                <span class="text-primary-400">${t.provider}</span> / ${meta.name || t.slug}
            `;
            document.getElementById('modal-tags').innerHTML = `
                 <span class="px-2 py-0.5 bg-slate-800 text-slate-400 text-xs rounded border border-slate-700">v${version}</span>
                 <span class="px-2 py-0.5 bg-slate-800 text-slate-400 text-xs rounded border border-slate-700">Author: ${meta.author}</span>
            `;
            
            // 解析 Markdown (使用 DOMPurify 防止 XSS)
            const readmeRaw = meta.readme || translations[currentLang].no_readme;
            const htmlContent = DOMPurify.sanitize(marked.parse(readmeRaw));
            document.getElementById('markdown-content').innerHTML = htmlContent;
            
            document.getElementById('modal-footer-info').textContent = `ID: ${t.id} • SHA: ${t.versions?.[version]?.sha256?.substring(0,8) || 'N/A'}`;

            // 绑定事件
            document.getElementById('modal-copy-btn').onclick = () => copyCommand(`redc pull ${t.id}`);

            // 动画显示
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');
            const modal = document.getElementById('modal');
            
            modal.classList.remove('hidden');
            // 强制重绘以触发 transition
            requestAnimationFrame(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'scale-95');
                panel.classList.add('scale-100');
            });
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const backdrop = document.getElementById('modal-backdrop');
            const panel = document.getElementById('modal-panel');
            const modal = document.getElementById('modal');

            backdrop.classList.add('opacity-0');
            panel.classList.remove('scale-100');
            panel.classList.add('opacity-0', 'scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 300); // 匹配 CSS transition duration
        }

        // 6. 辅助功能
        function copyCommand(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                const toastBody = document.getElementById('toast-body');
                
                toastBody.classList.remove('translate-y-20', 'opacity-0');
                
                setTimeout(() => {
                    toastBody.classList.add('translate-y-20', 'opacity-0');
                }, 2000);
            });
        }

        // 点击背景关闭
        document.getElementById('modal-backdrop').addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

    </script>
</body>
</html>