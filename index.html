<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redc Template Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        body { background-color: #0f172a; color: #e2e8f0; }
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="min-h-screen p-6 font-sans">
    <div class="max-w-7xl mx-auto">
        <header class="mb-12 text-center pt-8">
            <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-6">
                Redc Registry
            </h1>
            <p class="text-slate-400 text-lg mb-6">基于 Terraform 的红队基础设施模版仓库</p>
            
            <div class="inline-flex items-center gap-2 px-6 py-3 bg-slate-900/50 rounded-full text-base font-mono text-cyan-400 border border-slate-700 shadow-lg">
                <i data-lucide="terminal" class="w-5 h-5"></i>
                <span>redc pull <span class="text-slate-500">&lt;provider&gt;/&lt;template&gt;</span></span>
            </div>
        </header>

        <div class="mb-10 flex justify-center">
            <div class="relative w-full max-w-xl group">
                <i data-lucide="search" class="absolute left-4 top-3.5 text-slate-500 group-focus-within:text-cyan-400 transition"></i>
                <input type="text" id="search" placeholder="搜索模版 (例如: aws, c2, r0fus0d)..." 
                    class="w-full pl-12 pr-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition text-white placeholder-slate-500">
            </div>
        </div>

        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-500">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4"></i>
                <p>正在加载模版库数据...</p>
            </div>
        </div>

        <footer class="mt-20 border-t border-slate-800 pt-8 text-center text-slate-600 text-sm">
            <p id="build-info">Waiting for data...</p>
        </footer>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-cyan-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-24 transition-transform duration-300 flex items-center gap-2">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        <span>命令已复制!</span>
    </div>

    <script>
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        async function fetchData() {
            try {
                // 读取同级目录下的 index.json
                const response = await fetch('./index.json');
                if (!response.ok) throw new Error('Failed to load index.json');
                const data = await response.json();
                
                // 更新页脚时间
                const date = new Date(data.updated_at);
                document.getElementById('build-info').innerHTML = `Last Updated: ${date.toLocaleString()} • Repo: ${data.repo_name}`;

                renderTemplates(data.templates);
            } catch (error) {
                document.getElementById('grid').innerHTML = `
                    <div class="col-span-full text-center text-red-400 p-8 border border-red-900/50 rounded-xl bg-red-900/10">
                        <i data-lucide="alert-circle" class="w-10 h-10 mx-auto mb-4"></i>
                        <h3 class="text-lg font-bold">加载失败</h3>
                        <p class="text-sm opacity-80">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function renderTemplates(templates) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            templates.forEach(t => {
                const card = document.createElement('div');
                card.className = 'glass rounded-xl p-5 hover:border-cyan-500/50 hover:bg-slate-800/30 transition duration-300 group flex flex-col h-full';
                
                // 处理描述文本，防止太长
                const desc = t.metadata.description || '暂无描述';
                const author = t.metadata.author || 'Unknown';

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-1 text-[10px] font-bold bg-cyan-950 text-cyan-400 rounded border border-cyan-900/50 uppercase">
                                ${t.provider}
                            </span>
                        </div>
                        <span class="text-[10px] text-slate-600 font-mono" title="Commit Hash">#${t.sha256.substring(0, 6)}</span>
                    </div>

                    <h3 class="text-lg font-bold text-slate-100 group-hover:text-cyan-400 transition mb-2 truncate" title="${t.metadata.name}">
                        ${t.metadata.name}
                    </h3>
                    
                    <p class="text-slate-400 text-sm mb-4 line-clamp-2 h-10 leading-relaxed">
                        ${desc}
                    </p>

                    <div class="mt-auto pt-4 border-t border-slate-700/50">
                        <div class="flex items-center justify-between mb-3">
                             <div class="flex items-center gap-1.5 text-xs text-slate-500">
                                <i data-lucide="user" class="w-3 h-3"></i>
                                <span class="truncate max-w-[100px]">${author}</span>
                            </div>
                            <a href="${t.url}" class="text-slate-500 hover:text-cyan-400 transition" title="直接下载 ZIP">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </a>
                        </div>
                        
                        <button onclick="copyCommand('redc pull ${t.id}')" 
                            class="w-full flex items-center justify-center gap-2 py-2 bg-slate-800 hover:bg-cyan-900/30 text-slate-300 hover:text-cyan-400 text-xs font-mono rounded border border-slate-700 transition active:scale-95">
                            <i data-lucide="copy" class="w-3 h-3"></i>
                            redc pull ${t.id}
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            lucide.createIcons();
            setupSearch(templates);
        }

        function setupSearch(templates) {
            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = templates.filter(t => 
                    t.metadata.name.toLowerCase().includes(term) || 
                    t.metadata.description.toLowerCase().includes(term) ||
                    t.metadata.author.toLowerCase().includes(term) ||
                    t.id.toLowerCase().includes(term)
                );
                renderTemplates(filtered);
            });
        }

        function copyCommand(text) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.remove('translate-y-24');
                setTimeout(() => {
                    toast.classList.add('translate-y-24');
                }, 2000);
            });
        }
    </script>
</body>
</html>
